---
title       : NMIS Energy Data Overview
subtitle    : 
author      : Data Team, Modi Research Group
job         : 
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      # 
widgets     : []            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone, draft}

---

```{r echo=FALSE, warning=FALSE, message=FALSE}
setwd("~/Code/presentations/prabhas/energy-summaries/")
load('../NigeriaPresentationUtils.RData')
```
## Outline
1. Grid data from localities survey
2. Grid vs. solar vs. generator data from health + education surveys
3. Katsina -- example of detailed demand analysis

---

## 1. Localities survey

Total: 23,000+ localities in 654 LGAs. Heatmap of where localities were surveyed:

```{r echo=FALSE, warning=F, message=F, comment=NA, fig.height=6, fig.width=12, cache=TRUE}
library(doBy)
source('~/Code/formhub.R/R/formhub.R')
loc <- formhubRead("data/Local_661_Merged.csv", "data/Localities_05_06_2012.json")

loc <- rename(loc, c("X_lga_id" = "lga_id"))
loc <- merge(loc, read.csv("~/Dropbox/Nigeria/Nigeria 661 Baseline Data Cleaning/lgas.csv"),
             by="lga_id")

loc$grid <- loc$grid_proximity=='connected_to_grid'
loc$hhnum <- as.numeric(recodeVar(as.character(loc$households_number), 
                       src=c("101_to_250_hh", "21_to_50_hh", "251_to_500_hh", "51_to_100_hh","less_20_hh","more_500_hh"),
                       tgt=c('175', '35', '375', '75', '10', '750'), default=NA, keep.na=T))
library(ggplot2)
ggplot(data=loc, aes(x=X_gps_longitude, y=X_gps_latitude)) + geom_point() + stat_density2d(aes(fill = ..level.., alpha=0.2), geom="polygon") +
  theme(axis.title=element_blank(), axis.text=element_blank(), axis.ticks = element_blank(), 
        panel.grid=element_blank(), panel.background=element_rect(fill='#888888'), legend.position = "none")
```



```{r echo=F, warning=F, message=F, comment=NA, fig.height=6, fig.width=6, cache=TRUE}
lgaloc <- ddply(idata.frame(loc), .(lga_id), function(df) {
  data.frame(
    lga_id = df[1,'lga_id'],
    lga = df[1, 'lga'],
    state = df[1, 'state'],
    zone = df[1, 'zone'],
    HouseholdAggregate = sum(df$hhnum, na.rm=T),
    Population = df[1,'pop_2006'],
    Density = df[1,'pop_density_2006'],
    GridPct = bool_proportion(df$grid_proximity=='connected_to_grid'),
    GridFunctional = bool_proportion_string(df$electric_grid_questions.grid_functional_yn),
    HHGridPct = ratio(ifelse(df$grid, df$hhnum, 0), df$hhnum),
    IndividualSystems = bool_proportion_string(df$individual_electricity_systems_yn)
    )
})
```

---

## What % of localities have grid?
```{r echo=F, warning=F, message=F, comment=NA, fig.height=6, fig.width=6, cache=TRUE}
boxplot_by_zone(lgaloc, 'GridPct')
bin_and_map(lgaloc, 'GridPct')
```

---

## What % of households have grid?
```{r echo=F, warning=F, message=F, comment=NA, fig.height=6, fig.width=6, cache=TRUE}
boxplot_by_zone(lgaloc, 'HHGridPct')
bin_and_map(lgaloc, 'HHGridPct')
```

---

## What % of localities say the grid is functional?

```{r echo=F, warning=F, message=F, comment=NA, fig.height=6, fig.width=6, cache=TRUE}
boxplot_by_zone(lgaloc, 'GridFunctional')
bin_and_map(lgaloc, 'GridFunctional')
```

---

## What is the major problem with the grid?
Left: issues by locality, by zone. Right: Majority problem for LGA.

Grey = Less than 3 localities responded with a reason. Data subset from 971 localities in 145 LGAs.

```{r echo=F, warning=F, message=F, comment=NA, fig.height=5.5, fig.width=6, cache=TRUE}
loc$grid_problem <- factor(recodeVar(as.character(loc$electric_grid_questions.grid_problem), src=c("multiple_probs_derelict", "new_not_turned_on", "probs_network_1km", "probs_power_supply", "probs_transformer_1km", "other"), tgt=c("Multiple", "New; Never turned on", "In Network (<1km)", "Supply", "Transformer", "Other"), default=NA))
na_less_locs <- subset(loc, !is.na(loc$grid_problem))
problem_summary <- subset(ddply(idata.frame(na_less_locs), .(lga_id), function(df) {
  data.frame(MajorGridProblem= if(nrow(df) > 2) {df[which.max(df$grid_problem), 'grid_problem']} else {'NA'},
             lga_id = df[1,'lga_id'],
             zone=df[1,'zone']
  )
}), MajorGridProblem != 'NA')
barplot_by_zone(problem_summary, 'MajorGridProblem')
lga_map(geom_map(data = problem_summary, aes(map_id = lga_id, fill = MajorGridProblem), map=lgas), filltype="qual") + theme(legend.position='none')
```

---

## Use of back-up / "individual home" systems 

```{r echo=F, warning=F, message=F, comment=NA, fig.height=6, fig.width=6, cache=TRUE}
bin_and_map(lgaloc, 'IndividualSystems')
boxplot_by_zone(lgaloc, 'IndividualSystems')
```

---

## 2. Surveys at Health and Education Facilities
<font color="#00BFC4">Education</font> -- 69,000+ facilities, <font color="#F8766D">Health</font> -- 24,00+ facilities, across 768 LGAs.

```{r echo=FALSE, warning=F, message=F, comment=NA, fig.height=6, fig.width=12, cache=TRUE}
fac <- rbind(read.csv('data/EducationElectricityData.csv', na.strings=c("n/a","NA")),
             read.csv('data/HealthElectricityData.csv', na.strings=c("n/a","NA")))
ggplot(data=fac, aes(x=long, y=lat, color=sector, alpha=0.5)) + geom_point() + 
  xlim(2.6,14.7) + ylim(4.2,13.9) + scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  theme(axis.title=element_blank(), axis.text=element_blank(), axis.ticks = element_blank(), 
        panel.grid=element_blank(), panel.background=element_rect(fill='#888888'),
          legend.position = "none")
#+ stat_density2d(aes(fill = ..level.., alpha=0.2), geom="polygon")
```
```{r echo=FALSE, warning=F, message=F, comment=NA, fig.height=6, fig.width=12, cache=TRUE}
facagg <- ddply(idata.frame(fac), .(lga_id), function(df) {
  data.frame(
    lga_id = df[1,'lga_id'],
    HealthFacilities = icount(df$sector=="HEALTH"),
    EduFacilities = icount(df$sector=="EDUCATION"),
    ALLFAcilities = nrow(df),
    FunctionalPower_Health = bool_proportion(df$functional_power, df$sector=="HEALTH"),
    FunctionalPower_Education = bool_proportion(df$functional_power, df$sector=="EDUCATION"),
    FunctionalPower_Overall = bool_proportion(df$functional_power),
    Grid = bool_proportion(df$grid),
    Solar = bool_proportion(df$solar),
    Generator = bool_proportion(df$genset),
    GridFunctional = bool_proportion(df$grid_functional=='yes', df$grid),
    SolarFunctional = bool_proportion(df$solar_functional=='yes', df$solar),
    GeneratorFunctional = bool_proportion(df$generator_functional=='yes', df$genset)
  )
})
lgaas <- read.csv('~/Dropbox/Nigeria/Nigeria 661 Baseline Data Cleaning/lgas.csv')
facagg <- merge(facagg, lgaas, by="lga_id")
```
---

## What % use ...

```{r echo=F, warning=F, message=F, comment=NA, fig.height=4, fig.width=4, cache=TRUE}
boxplot_by_zone(facagg, 'Grid')
boxplot_by_zone(facagg, 'Generator')
boxplot_by_zone(facagg, 'Solar')
bin_and_map(facagg, 'Grid', nostatename=TRUE)
bin_and_map(facagg, 'Generator', nostatename=TRUE)
bin_and_map(facagg, 'Solar', nostatename=TRUE)
```

---

## Which electric system is dominant?

```{r echo=F, warning=F, message=F, comment=NA, fig.height=6, fig.width=6, cache=TRUE}
g <- replace(facagg$Grid, is.na(facagg$Grid), 0)
s <- replace(facagg$Solar, is.na(facagg$Solar), 0)
n <- replace(facagg$Generator, is.na(facagg$Generator), 0)
gt <- (function(eps) { function(a, b) { (a - b) > eps }}) (.1)

facagg$DominantElectricSystem <- 
  ifelse(gt(g,s) & gt(g,n),'GRID',
  ifelse(gt(n,s) & gt(n,g), 'GEN',
  ifelse(gt(s,n) & gt(s,g),'SOLAR',
  # no dominance
  ifelse(gt(s,n) & gt(g,n), 'GRID | SOLAR',
  ifelse(gt(g,s) & gt(n,s), 'GEN | GRID',
  ifelse(gt(n,g) & gt(s,g), 'SOLAR | GEN',
         'No dominance'))))))
  
barplot_by_zone(facagg, 'DominantElectricSystem') 
lga_map(geom_map(data = facagg, aes(map_id = lga_id, fill = DominantElectricSystem), map=lgas), filltype="qual") + theme(legend.position='none')
```
---

## What is functional?

```{r echo=F, warning=F, message=F, comment=NA, fig.height=4, fig.width=4, cache=TRUE}

boxplot_by_zone(facagg, 'GridFunctional')
boxplot_by_zone(facagg, 'GeneratorFunctional')
boxplot_by_zone(facagg, 'SolarFunctional')
bin_and_map(facagg, 'GridFunctional', nostatename=TRUE)
bin_and_map(facagg, 'GeneratorFunctional', nostatename=TRUE)
bin_and_map(facagg, 'SolarFunctional', nostatename=TRUE)

```

---

## Functional Power

```{r echo=F, warning=F, message=F, comment=NA, fig.height=4, fig.width=6, cache=TRUE}
boxplot_by_zone(facagg, 'FunctionalPower_Health')
boxplot_by_zone(facagg, 'FunctionalPower_Education')
bin_and_map(facagg, 'FunctionalPower_Health', nostatename=TRUE)
bin_and_map(facagg, 'FunctionalPower_Education', nostatename=TRUE)
```

